

-- ITEM TABLE
INSERT INTO ITEM(ID_ITEM, NAME, DESCRIPTION, PRICE_TO_BUY, PRICE_TO_SELL)
SELECT
    TO_NUMBER(ID),
    NAME,
    DESCRIPTION,
    TO_NUMBER(PRICE_TO_BUY),
    TO_NUMBER(PRICE_TO_SELL)
FROM ITEMS_DATA;

-- FOOD TABLE
INSERT INTO FOOD (ID_FOOD, INGREDIENTS, ENERGY_REGAIN, HEALTH_REGAIN)
SELECT DISTINCT
   TO_NUMBER(ID),
   INGREDIENTS,
   TO_NUMBER(ENERGY),
   TO_NUMBER(HEALTH)
FROM ITEMS_DATA
WHERE INGREDIENTS IS NOT NULL AND ENERGY IS NOT NULL AND HEALTH IS NOT NULL;

-- SEED TABLE
INSERT INTO SEED (ID_SEED, SEED_TYPE, NAME_CROP)
SELECT
   TO_NUMBER(ID),
   TYPE,
   NAME_CROP
FROM ITEMS_DATA
WHERE NAME_CROP IS NOT NULL;

-- SUPPLY TABLE
INSERT INTO SUPPLY (ID_SUPPLY, NUTRITIONAL_VALUE, NUTRITIONAL_QUALITIES)
SELECT
   TO_NUMBER(ID),
   TO_NUMBER(NUTRITIONAL_VALUE),
   QUALITY
FROM ITEMS_DATA
WHERE NUTRITIONAL_VALUE IS NOT NULL
 AND QUALITY IS NOT NULL
 AND NOT EXISTS (
     SELECT 1 FROM SUPPLY s
     WHERE s.ID_SUPPLY = TO_NUMBER(ITEMS_DATA.ID)
 );

-- ANIMAL SPECIE TABLE
INSERT INTO ANIMAL_SPECIE (ID_ANIMAL_SPECIE, SPECIE_NAME)
SELECT ROWNUM, SPECIE_NAME
FROM (
   SELECT DISTINCT ANIMAL_SPECIE AS SPECIE_NAME FROM ITEMS_DATA WHERE ANIMAL_SPECIE IS NOT NULL
   UNION
   SELECT DISTINCT ANIMAL_SPECIE AS SPECIE_NAME FROM ANIMALS_PRODUCTS WHERE ANIMAL_SPECIE IS NOT NULL
);


-- PLACE TABLE 
INSERT INTO PLACE (
 ID_PLACE,
 LOCATION_NAME,
 COORDINATES
)
SELECT
 ROWNUM   AS ID_PLACE,
 LOCATION_NAME,
 COORDINATES
FROM (
 -- 1) from festivity shops 
 SELECT DISTINCT
   LOCATION_NAME,
   COORDENATES AS COORDINATES
 FROM FESTIVITY_SHOPS
 WHERE LOCATION_NAME IS NOT NULL
   AND COORDENATES   IS NOT NULL
 UNION
 -- 2) from festivity persons
 SELECT DISTINCT
   LOCATION_NAME,
   COORDENATES AS COORDINATES
 FROM FESTIVITY_PERSONS
 WHERE LOCATION_NAME IS NOT NULL
   AND COORDENATES   IS NOT NULL
 UNION
 -- 3) from events 
 SELECT DISTINCT
   LOCATION_NAME,
   COORDENATES AS COORDINATES
 FROM EVENTS
 WHERE LOCATION_NAME IS NOT NULL
   AND COORDENATES   IS NOT NULL
 UNION
 -- 4) from schedules 
 SELECT DISTINCT
   LOCATION_NAME,
   COORDENATES AS COORDINATES
 FROM SCHEDULES
 WHERE LOCATION_NAME IS NOT NULL
   AND COORDENATES   IS NOT NULL
);  

-- Character (PLAYER_IDs only)
INSERT INTO CHARACTER (
  ID_CHARACTER,
  NAME,
  AGE,
  GENDER,
  ID_VILLAGE
)
SELECT
  TO_NUMBER(ID) AS ID_CHARACTER,
  NAME,
  TO_NUMBER(AGE) AS AGE,
  GENDER,
  NULL AS ID_VILLAGE 
FROM (
  SELECT pd.*,
    ROW_NUMBER() OVER (PARTITION BY ID ORDER BY ROWNUM) as rn
  FROM PLAYER_DATA pd
) filtered
WHERE filtered.rn = 1; 

-- PLAYER
INSERT INTO PLAYER (
  ID_PLAYER, 
  AVATAR_APPEARANCE, 
  NICKNAME, GOLD, 
  EXPERIENCE, 
  SKILL_LEVEL, 
  SKILL)
SELECT 
  TO_NUMBER(ID), 
  APPARENCE, 
  NICKNAME, 
  TO_NUMBER(GOLD), 
  TO_NUMBER(EXPERIENCE), 
  TO_NUMBER(SKILL_LEVEL), 
  SKILL
FROM PLAYER_DATA pd
WHERE ROWID = (
  SELECT MIN(ROWID) 
  FROM PLAYER_DATA 
  WHERE ID = pd.ID
);


-- SHOP table
INSERT INTO SHOP (
ID_SHOP,
  NAME_SHOP,
  DESCRIPTION,
  SPECIALIZATION,
  ID_PLACE)
SELECT DISTINCT
  TO_NUMBER(t.ID_SHOP) AS ID_SHOP,
  t.NAME               AS NAME_SHOP,
  t.DESCRIPTION,
  t.SPECIALIZATION,
  ( SELECT ID_PLACE                      
      FROM   PLACE pl WHERE  pl.LOCATION_NAME = t.LOCATION_NAME
      AND    ROWNUM = 1 ) AS ID_PLACE
FROM   TRANSACTIONS t
WHERE  NOT EXISTS ( 
  SELECT 1
  FROM   SHOP s
  WHERE  s.ID_SHOP = TO_NUMBER(t.ID_SHOP) );

-- P_STORED table
INSERT INTO P_STORED 
        (ID_ITEM, ID_PLAYER, QUANTITY)
SELECT  ID_ITEM,
        ID_PLAYER,
        SUM(AMOUNT) AS QUANTITY
FROM    INVENTORIES
WHERE   ID_PLAYER IS NOT NULL
GROUP BY ID_ITEM, ID_PLAYER;

--S_STORED table

INSERT INTO S_STORED 
        (ID_ITEM, ID_SHOP, QUANTITY)
SELECT  ID_ITEM,
        ID_SHOP,
        SUM(AMOUNT) AS QUANTITY -- I use it to sum all occurances of the same item in different shops bought by same player
FROM    INVENTORIES
WHERE   ID_SHOP IS NOT NULL
GROUP BY ID_ITEM, ID_SHOP;

-- BUY_SELL table Buy side
INSERT INTO BUY_SELL (
        ID_SHOP,
        ID_ITEM,
        ID_PLAYER,
        ACTION_TIME,
        ACTION,
        MONEY_FLUCTUATION,
        AMOUNT
)
SELECT  t.ID_SHOP,
        t.BUY_ITEM                       AS ID_ITEM,
        t.CLIENT                         AS ID_PLAYER,
        MAX(t.DATE_OF_PURCHASE)          AS ACTION_TIME,      -- PK column
        'BUY'                            AS ACTION,
        -1 * MAX(it.PRICE_TO_BUY)        -- money flows *out* of player
            * SUM(t.AMOUNT_TO_BUY)       AS MONEY_FLUCTUATION,
        SUM(t.AMOUNT_TO_BUY)             AS AMOUNT
FROM    TRANSACTIONS t
JOIN    ITEM  it  ON it.ID_ITEM  = t.BUY_ITEM      -- pull price
JOIN    SHOP  sp  ON sp.ID_SHOP  = t.ID_SHOP       -- FK guard
JOIN    PLAYER pl ON pl.ID_PLAYER = t.CLIENT
WHERE   t.ID_SHOP         IS NOT NULL
  AND   t.BUY_ITEM        IS NOT NULL
  AND   t.CLIENT          IS NOT NULL
  AND   t.AMOUNT_TO_BUY   IS NOT NULL
  AND   t.DATE_OF_PURCHASE IS NOT NULL
GROUP BY t.ID_SHOP,
         t.BUY_ITEM,
         t.CLIENT;

-- BUY_SELL table SELL side
INSERT INTO BUY_SELL (
        ID_SHOP,
        ID_ITEM,
        ID_PLAYER,
        ACTION_TIME,
        ACTION,
        MONEY_FLUCTUATION,
        AMOUNT
)
  SELECT  t.ID_SHOP,
          t.SELLS_ITEM                                          AS ID_ITEM,
        t.CLIENT2                                               AS ID_PLAYER,
        MAX(t.DATE_OF_SALE)                                     AS ACTION_TIME,
        'SELL'                                                  AS ACTION,
        +1 * MAX(it.PRICE_TO_SELL) * SUM(t.AMOUNT_TO_SELL)      AS MONEY_FLUCTUATION,
        SUM(t.AMOUNT_TO_SELL)                                   AS AMOUNT
FROM    TRANSACTIONS t
    JOIN    ITEM  it  ON it.ID_ITEM  = t.SELLS_ITEM
    JOIN    SHOP  sp  ON sp.ID_SHOP  = t.ID_SHOP
    JOIN    PLAYER pl ON pl.ID_PLAYER = t.CLIENT2
WHERE   t.ID_SHOP        IS NOT NULL
    AND   t.SELLS_ITEM     IS NOT NULL
    AND   t.CLIENT2        IS NOT NULL
    AND   t.AMOUNT_TO_SELL IS NOT NULL
    AND   t.DATE_OF_SALE   IS NOT NULL
GROUP BY t.ID_SHOP,
         t.SELLS_ITEM,
         t.CLIENT2;

-- FEED table
INSERT INTO FEED (ID_SUPPLY,
                  ID_ANIMAL_SPECIE)
SELECT DISTINCT
       s.ID_SUPPLY,
       sp.ID_ANIMAL_SPECIE
FROM   ITEMS_DATA it
  JOIN SUPPLY s
    ON s.ID_SUPPLY = TO_NUMBER(it.ID)
   AND it.NUTRITIONAL_VALUE    IS NOT NULL
   AND it.QUALITY IS NOT NULL

  JOIN ANIMAL_SPECIE sp
    ON sp.SPECIE_NAME = it.ANIMAL_SPECIE

WHERE  NOT EXISTS (
         SELECT 1
         FROM   FEED f
         WHERE  f.ID_SUPPLY        = s.ID_SUPPLY
           AND  f.ID_ANIMAL_SPECIE = sp.ID_ANIMAL_SPECIE
       );


-- Schedule (inserts from shop side)
INSERT INTO SCHEDULE (
    ID_SCHEDULE,
    SEASON,
    START_TIME,
    END_TIME,
    DAY_OF_WEEK
)
WITH distinct_slots AS (
  SELECT DISTINCT
         START_SCHEDULE AS START_TIME,
         END_SCHEDULE   AS END_TIME,
         DAY_OF_WEEK
  FROM   INVENTORIES
  WHERE  START_SCHEDULE IS NOT NULL
    AND  END_SCHEDULE   IS NOT NULL
    AND  DAY_OF_WEEK    IS NOT NULL
)
SELECT
    ROWNUM               AS ID_SCHEDULE,
    NULL                 AS SEASON,   
    ds.START_TIME,
    ds.END_TIME,
    ds.DAY_OF_WEEK
FROM distinct_slots ds;


-- Follow table
INSERT INTO FOLLOW (ID_SHOP,
                    ID_SCHEDULE)
SELECT DISTINCT
       iv.ID_SHOP,
       sch.ID_SCHEDULE
FROM   INVENTORIES iv

      
JOIN   SCHEDULE sch
  ON   sch.DAY_OF_WEEK = iv.DAY_OF_WEEK
 AND   sch.START_TIME  = iv.START_SCHEDULE
 AND   sch.END_TIME    = iv.END_SCHEDULE

    
JOIN   SHOP sp
  ON   sp.ID_SHOP = iv.ID_SHOP

WHERE  iv.ID_SHOP        IS NOT NULL
  AND  iv.DAY_OF_WEEK    IS NOT NULL
  AND  iv.START_SCHEDULE IS NOT NULL
  AND  iv.END_SCHEDULE   IS NOT NULL

  AND NOT EXISTS (
        SELECT 1
        FROM   FOLLOW f
        WHERE  f.ID_SHOP     = iv.ID_SHOP
          AND  f.ID_SCHEDULE = sch.ID_SCHEDULE
      );





